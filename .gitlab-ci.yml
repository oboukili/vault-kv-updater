---
stages:
  - build
  - release

build:
  stage: build
  image: golang:1.12-alpine
  variables:
    GOPATH: /go
  before_script:
    - apk --no-cache --update add git make
    - make deps
  script:
    - make ci-build
  artifacts:
    paths:
      - /go/vault-kv-updater
    expire_in: 1 day
  cache:
    key: "${CI_JOB_STAGE}"
    paths:
      - /go/src/github.com
      - /go/src/golang.org
      - /go/src/google.golang.org
      - /go/src/gopkg.in
  tags:
    - kubernetes

release:
  stage: release
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.10.0
    entrypoint: [""]
  script:
    - >
      /kaniko/executor \
        --single-snapshot \
        --cache true \
        --destination eu.gcr.io/malt-build/${CI_PROJECT_NAME}:${CI_COMMIT_REF_SLUG} \
        --destination eu.gcr.io/malt-build/${CI_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA}
  dependencies:
    - build
  except:
    changes:
      - .gitignore
      - LICENSE
      - README.md
  tags:
    - kubernetes
